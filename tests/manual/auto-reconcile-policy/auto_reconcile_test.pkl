/*
 * Â© 2025 Platform Engineering Labs Inc.
 *
 * SPDX-License-Identifier: FSL-1.1-ALv2
 */

amends "@formae/forma.pkl"

import "@formae/formae.pkl"
import "@aws/aws.pkl"
import "@aws/ec2/internetgateway.pkl"

// === Standalone Auto-Reconcile Policy ===
// This policy will be attached to stack-standalone via reference
local standaloneAutoReconcile = new formae.AutoReconcilePolicy {
    label = "recon-every-2min"
    interval = 2.min
}

// === Target ===
local testTarget = new formae.Target {
    label = "auto-recon-target"
    config = new aws.Config {
        region = "us-east-1"
    }
}

// === Stack with Inline Auto-Reconcile Policy ===
local stackInline = new formae.Stack {
    label = "auto-recon-inline"
    description = "Stack with inline auto-reconcile policy (2 min interval)"
    policies = new Listing {
        new formae.AutoReconcilePolicy {
            label = "inline-recon-2min"
            interval = 2.min
        }
    }
}

// === Stack with Standalone Auto-Reconcile Policy (via reference) ===
local stackStandalone = new formae.Stack {
    label = "auto-recon-standalone"
    description = "Stack with standalone auto-reconcile policy reference (2 min interval)"
    policies = new Listing { standaloneAutoReconcile.res }
}

// === Resources ===
forma {
    // Standalone policy
    standaloneAutoReconcile

    // Target
    testTarget

    // Stacks
    stackInline
    stackStandalone

    // Internet Gateway for inline policy stack
    new internetgateway.InternetGateway {
        label = "igw-inline"
        stack = stackInline.res
        target = testTarget.res
        tags { new { key = "Name"; value = "formae-auto-recon-inline" } }
    }

    // Internet Gateway for standalone policy stack
    new internetgateway.InternetGateway {
        label = "igw-standalone"
        stack = stackStandalone.res
        target = testTarget.res
        tags { new { key = "Name"; value = "formae-auto-recon-standalone" } }
    }
}
