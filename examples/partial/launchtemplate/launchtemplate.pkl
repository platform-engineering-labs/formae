/*
 * Â© 2025 Platform Engineering Labs Inc.
 *
 * SPDX-License-Identifier: FSL-1.1-ALv2
 */

amends "@formae/forma.pkl"
import "@formae/formae.pkl"

import "@aws/aws.pkl"
import "@aws/ec2/launchtemplate.pkl"
import "@aws/ec2/vpc.pkl"
import "@aws/ec2/subnet.pkl"
import "@aws/ec2/securitygroup.pkl"
import "@aws/ec2/keypair.pkl"

local stackName = "launch-template-example"

// Create a VPC for our resources
local v = new vpc.VPC {
    Label = "lt-vpc"
    CidrBlock = "10.0.0.0/16"
    EnableDnsHostnames = true
    EnableDnsSupport = true
    Tags {
        new formae.Tag {
            Key = "Name"
            Value = "launch-template-vpc"
        }
    }
}

// Create a subnet
local s = new subnet.Subnet {
    Label = "lt-subnet"
    VpcId = vpc.res.Id
    CidrBlock = "10.0.1.0/24"
    AvailabilityZone = "us-east-1a"
    MapPublicIpOnLaunch = true
    Tags {
        new formae.Tag {
            Key = "Name"
            Value = "launch-template-subnet"
        }
    }
}

// Create a security group
local securityGroup = new securitygroup.SecurityGroup {
    Label = "lt-security-group"
    GroupDescription = "Security group for launch template instances"
    VpcId = vpc.res.Id
    SecurityGroupIngress {
        new securitygroup.SecurityGroupSecurityGroupRule {
            IpProtocol = "tcp"
            FromPort = 22
            ToPort = 22
            CidrIp = "0.0.0.0/0"
            Description = "SSH access"
        }
        new securitygroup.SecurityGroupSecurityGroupRule {
            IpProtocol = "tcp"
            FromPort = 80
            ToPort = 80
            CidrIp = "0.0.0.0/0"
            Description = "HTTP access"
        }
        new securitygroup.SecurityGroupSecurityGroupRule {
            IpProtocol = "tcp"
            FromPort = 443
            ToPort = 443
            CidrIp = "0.0.0.0/0"
            Description = "HTTPS access"
        }
    }
    Tags {
        new formae.Tag {
            Key = "Name"
            Value = "launch-template-sg"
        }
    }
}

// Create a key pair
local keyPair = new keypair.KeyPair {
    Label = "lt-keypair"
    KeyName = "launch-template-keypair"
    Tags {
        new formae.Tag {
            Key = "Name"
            Value = "launch-template-keypair"
        }
    }
}

// Create the Launch Template
local launchTemplate = new launchtemplate.LaunchTemplate {
    Label = "web-server-launch-template"
    LaunchTemplateName = "web-server-template"
    //LaunchTemplateData = new launchtemplate.LaunchTemplateLaunchTemplateData {
    //    // AMI ID (Amazon Linux 2023)
    //    ImageId = "ami-0c02fb55956c7d316"
    //
    //    // Instance type
    //    InstanceType = "t3.micro"
    //
    //    // Key pair for SSH access
    //    KeyName = keyPair.KeyName
    //
    //    // Security groups
    //    SecurityGroupIds {
    //        securityGroup.res.GroupId
    //    }
    //    //    // EBS optimization
    //    EbsOptimized = true
    //
    //    // Block device mappings
    //    BlockDeviceMappings {
    //        new launchtemplate.LaunchTemplateBlockDeviceMapping {
    //            DeviceName = "/dev/xvda"
    //            Ebs = new launchtemplate.LaunchTemplateEbs {
    //                VolumeSize = 20
    //                VolumeType = "gp3"
    //                DeleteOnTermination = true
    //                Encrypted = true
    //            }
    //        }
    //    }
    //
    //    // IAM instance profile (optional)
    //    IamInstanceProfile = new launchtemplate.LaunchTemplateIamInstanceProfile {
    //        Name = "EC2InstanceProfile"  // Assumes this role exists
    //    }
    //
    //    // Monitoring
    //    Monitoring = new launchtemplate.LaunchTemplateMonitoring {
    //        Enabled = true
    //    }
    //    //    // Metadata options (IMDSv2)
    //    MetadataOptions = new launchtemplate.LaunchTemplateMetadataOptions {
    //        HttpEndpoint = "enabled"
    //        HttpTokens = "required"
    //        HttpPutResponseHopLimit = 2
    //        InstanceMetadataTags = "enabled"
    //    }
    //
    //    // User data script
    //    UserData = """
    //        #!/bin/bash
    //        yum update -y
    //        yum install -y httpd
    //        systemctl start httpd
    //        systemctl enable httpd
    //
    //        # Create a simple web page
    //        cat <<EOF > /var/www/html/index.html
    //        <!DOCTYPE html>
    //        <html>
    //        <head>
    //            <title>Launch Template Instance</title>
    //        </head>
    //        <body>
    //            <h1>Hello from Launch Template!</h1>
    //            <p>This instance was launched using an EC2 Launch Template.</p>
    //            <p>Instance ID: $(curl -s http://169.254.169.254/latest/meta-data/instance-id)</p>
    //            <p>Availability Zone: $(curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone)</p>
    //        </body>
    //        </html>
    //        EOF
    //
    //        # Set proper permissions
    //        chown apache:apache /var/www/html/index.html
    //    """.base64
    //
    //    // Network interfaces configuration
    //    NetworkInterfaces {
    //        new launchtemplate.LaunchTemplateNetworkInterface {
    //            DeviceIndex = 0
    //            AssociatePublicIpAddress = true
    //            SubnetId = subnet.res.Id
    //            DeleteOnTermination = true
    //            Groups {
    //                securityGroup.res.GroupId
    //            }
    //        }
    //    }
    //
    //    // Instance requirements (for mixed instance types - optional)
    //    InstanceRequirements = new launchtemplate.LaunchTemplateInstanceRequirements {
    //        VCpuCount = new launchtemplate.LaunchTemplateVCpuCount {
    //            Min = 1
    //            Max = 4
    //        }
    //        MemoryMiB = new launchtemplate.LaunchTemplateMemoryMiB {
    //            Min = 1024
    //            Max = 8192
    //        }
    //        CpuManufacturers {
    //            "intel"
    //            "amd"
    //        }
    //        InstanceGenerations {
    //            "current"
    //        }
    //    }
    //
    //    // Placement configuration
    //    Placement = new launchtemplate.LaunchTemplatePlacement {
    //        AvailabilityZone = "us-east-1a"
    //        Tenancy = "default"
    //    }
    //
    //    // Credit specification for burstable instances
    //    CreditSpecification = new launchtemplate.LaunchTemplateCreditSpecification {
    //        CpuCredits = "standard"
    //    }
    //    // Tag specifications for launched instances
    //    TagSpecifications {
    //        new launchtemplate.LaunchTemplateTagSpecification {
    //            ResourceType = "instance"
    //            Tags {
    //                new formae.Tag {
    //                    Key = "Name"
    //                    Value = "WebServer-LaunchedFromTemplate"
    //                }
    //                new formae.Tag {
    //                    Key = "Environment"
    //                    Value = "Production"
    //                }
    //                new formae.Tag {
    //                    Key = "LaunchedFrom"
    //                    Value = "LaunchTemplate"
    //                }
    //            }
    //        }
    //        new launchtemplate.LaunchTemplateTagSpecification {
    //            ResourceType = "volume"
    //            Tags {
    //                new formae.Tag {
    //                    Key = "Name"
    //                    Value = "WebServer-Volume"
    //                }
    //            }
    //        }
    //    }
    //        // Shutdown behavior
    //        InstanceInitiatedShutdownBehavior = "terminate"//
    //        // API termination protection
    //        DisableApiTermination = false
    //    }

    // Version description
    VersionDescription = "Initial version of web server launch template"

    // Tags for the launch template itself
    TagSpecifications {
        new launchtemplate.LaunchTemplateLaunchTemplateTagSpecification {
            ResourceType = "launch-template"
            Tags {
                new formae.Tag {
                    Key = "Name"
                    Value = "WebServerLaunchTemplate"
                }
                new formae.Tag {
                    Key = "Purpose"
                    Value = "WebServerDeployment"
                }
            }
        }
    }
}

Forma {
    new formae.Stack {
        Label = stackName
        Description = "EC2 Launch Template example with comprehensive configuration"
    }

    new formae.Target {
        Label = "aws-target"
        Config = new aws.Config {
            Region = "us-west-1"
        }
    }

    // Infrastructure
    //vpc
    //subnet
    //securityGroup
    //keyPair

    // Launch Template
    launchTemplate
}