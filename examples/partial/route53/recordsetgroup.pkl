/*
 * Â© 2025 Platform Engineering Labs Inc.
 *
 * SPDX-License-Identifier: FSL-1.1-ALv2
 */

amends "@formae/forma.pkl"
import "@formae/formae.pkl"
import "@aws/aws.pkl"
import "@aws/route53/hostedzone.pkl"
import "@aws/route53/recordsetgroup.pkl"

properties {
    name = new formae.Prop {
        flag = "name"
        default = "example.com"
    }
}

forma {
    local stack = new formae.Stack {
        label = "pel-dns-records"
        description = "Stack for DNS Record Sets"
    }
    stack

    local target = new formae.Target {
        label = "default-aws-target"
        config = new aws.Config {
            region = "us-west-2"
        }
    }
    target

    // Create the hosted zone first
    local zone = new hostedzone.HostedZone {
        label = "example-zone"
        name = properties.name.value
    }
    zone

    // Create record set group
    new recordsetgroup.RecordSetGroup {
        label = "example-records"
        hostedZoneId = zone.res.id
        comment = "Example DNS records"

        recordSets = new Listing {
            // A record with geo-location routing
            new recordsetgroup.RecordSetGroupRecordSet {
                name = "www.example.com"
                type = "A"
                ttl = "300"
                setIdentifier = "Primary"
                geoLocation = new recordsetgroup.RecordSetGroupGeoLocation {
                    continentCode = "NA"
                }
                resourceRecords = new Listing {
                    "192.0.2.1"
                }
            }

            // CNAME record
            new recordsetgroup.RecordSetGroupRecordSet {
                name = "mail.example.com"
                type = "CNAME"
                ttl = "300"
                resourceRecords = new Listing {
                    "mailserver.example.com"
                }
            }

            // Alias record pointing to CloudFront
            new recordsetgroup.RecordSetGroupRecordSet {
                name = "cdn.example.com"
                type = "A"
                aliasTarget = new recordsetgroup.RecordSetGroupAliasTarget {
                    dnsName = "d123456789.cloudfront.net"
                    hostedZoneId = "Z2FDTNDATAQYW2"  // CloudFront's hosted zone ID
                    evaluateTargetHealth = true
                }
            }

            // Multi-value answer record
            new recordsetgroup.RecordSetGroupRecordSet {
                name = "api.example.com"
                type = "A"
                ttl = "60"
                multiValueAnswer = true
                setIdentifier = "API-1"
                resourceRecords = new Listing {
                    "192.0.2.2"
                    "192.0.2.3"
                }
            }
        }
    }
}