/*
 * Â© 2025 Platform Engineering Labs Inc.
 *
 * SPDX-License-Identifier: FSL-1.1-ALv2
 */

amends "@formae/forma.pkl"
import "@formae/formae.pkl"
import "@aws/aws.pkl"

import "infrastructure/platform.pkl"
import "vars.pkl"

description {
    text = """
    Machine Learning Platform Infrastructure.

    This forma provisions a complete ML platform built on Amazon SageMaker with 
    supporting infrastructure.

    This includes:
    - SageMaker domain and user profiles for data scientists and MLOps
    - Custom EFS file system with user-specific access points and encryption
    - VPC networking with public/private subnets across multiple AZs
    - Security groups for SageMaker and EFS communication
    - KMS encryption for data at rest
    - S3 buckets for training data and model artifacts
    - ECR repositories for custom ML container images
    - PostgreSQL DB for feature storage with encryption
    - Model package group for versioned model management
    - CloudWatch monitoring for ML ops
    - ECS cluster for containerized ML workflows
    
    The platform uses a custom EFS file system with AutoMountHomeEFS disabled 
    to provide isolated, encrypted storage for each user role.
    
    The resulting platform enables secure, scalable, and collaborative ML workflows 
    from experimentation to production deployment.
    """
    confirm = true
}

local mlPlatform = new platform.MLPlatform {
  name = vars.properties.name.value
  region = vars.properties.region.value
  accountId = vars.properties.accountId.value
  vpcCidr = vars.properties.vpcCidr.value
  
  publicZoneCidrs {
    ["a"] = vars.properties.publicSubnetACidr.value
    ["b"] = vars.properties.publicSubnetBCidr.value
  }
  privateZoneCidrs {
    ["a"] = vars.properties.privateSubnetACidr.value
    ["b"] = vars.properties.privateSubnetBCidr.value
  }

  dbInstanceClass = vars.properties.dbInstanceClass.value
  dbUsername = vars.properties.dbUsername.value
}

forma {
  vars.stack
  vars.target
  ...mlPlatform.resources
}