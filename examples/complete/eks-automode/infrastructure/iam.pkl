/*
 * Â© 2025 Platform Engineering Labs Inc.
 *
 * SPDX-License-Identifier: FSL-1.1-ALv2
 */

import "@aws/iam/role.pkl"

import "../vars.pkl"

function clusterRole(properties: Dynamic?): role.Role = new role.Role {
    label = "eks-cluster-role"

    assumeRolePolicyDocument {
        ["Version"] = "2012-10-17"
        ["Statement"] {
            new {
                ["Effect"] = "Allow"
                ["Principal"] {
                    ["Service"] = "eks.amazonaws.com"
                }
                ["Action"] = new Listing {"sts:AssumeRole" "sts:TagSession"}
            }
        }
    }
    
    managedPolicyArns {
        "arn:aws:iam::aws:policy/AmazonEKSClusterPolicy"
        "arn:aws:iam::aws:policy/AmazonEKSComputePolicy" 
        "arn:aws:iam::aws:policy/AmazonEKSBlockStoragePolicy" 
        "arn:aws:iam::aws:policy/AmazonEKSLoadBalancingPolicy"
        "arn:aws:iam::aws:policy/AmazonEKSNetworkingPolicy" 
    }

    tags { new { key = "Name"; value = properties.name.value + "-cluster-role" } }
}

function nodeRole(properties: Dynamic?): role.Role = new role.Role {
    label = "eks-node-role"
    
    assumeRolePolicyDocument {
        ["Version"] = "2012-10-17"
        ["Statement"] {
            new {
                ["Effect"] = "Allow"
                ["Principal"] {
                    ["Service"] = "ec2.amazonaws.com"
                }
                ["Action"] = "sts:AssumeRole"
            }
        }
    }
    
    managedPolicyArns {
        "arn:aws:iam::aws:policy/AmazonEKSWorkerNodeMinimalPolicy"
        "arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryPullOnly"
    }

    tags { new { key = "Name"; value = properties.name.value + "-node-role" } }
}