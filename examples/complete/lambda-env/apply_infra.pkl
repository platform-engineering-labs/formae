/*
 * Â© 2025 Platform Engineering Labs Inc.
 *
 * SPDX-License-Identifier: FSL-1.1-ALv2
 */

amends "@formae/forma.pkl"
import "@formae/formae.pkl"

import "./infrastructure/network.pkl"
import "./infrastructure/storage.pkl"
import "./infrastructure/security.pkl"

import "vars.pkl"

description {
    text ="""
    This example demonstrates how to deploy a Lambda function that uses env variables to
    access other AWS resources. This file provisions foundational AWS infrastructure.

    This includes:
        - RDS Postgres DB in private subnets
        - VPC with private subnets and security groups
        - S3 buckets for deployment and data storage
        - IAM roles with VPC Lambda execution permissions

    Note: This file does not create the Lambda function. It prepares all required
    resources for its secure deployment (which occurs in a later step).
    """
    confirm = true
}

forma {
    vars.stack
    vars.target

    network.vpc(vars.properties)
    network.internetGateway(vars.properties)
    network.vpcGatewayAttachment(vars.properties)
    ...network.privateSubnets(vars.properties)

    security.lambdaRole(vars.properties)
    ...security.securityGroups(vars.properties)

    storage.deploymentBucket(vars.properties)
    storage.dataBucket(vars.properties)
    storage.dbSubnetGroup(vars.properties)
    storage.postgres(vars.properties)
}