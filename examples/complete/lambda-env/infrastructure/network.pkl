/*
 * Â© 2025 Platform Engineering Labs Inc.
 *
 * SPDX-License-Identifier: FSL-1.1-ALv2
 */

import "@aws/ec2/vpc.pkl"
import "@aws/ec2/subnet.pkl"
import "@aws/ec2/internetgateway.pkl"
import "@aws/ec2/vpcgatewayattachment.pkl"

import "../vars.pkl"

function vpc(properties: Dynamic?): vpc.VPC = new vpc.VPC {
    label = "LambdaVPC"
    cidrBlock = "10.0.0.0/16"
    enableDnsHostnames = true
    enableDnsSupport = true
    tags {
        new { key = "Name"; value = properties.name.value + "-vpc" }
    }
}

function internetGateway(properties: Dynamic?): internetgateway.InternetGateway = new internetgateway.InternetGateway {
    label = "InternetGateway"
    tags {
        new { key = "Name"; value = properties.name.value + "-igw" }
    }
}

function vpcGatewayAttachment(properties: Dynamic?): vpcgatewayattachment.VPCGatewayAttachment = new vpcgatewayattachment.VPCGatewayAttachment {
    label = "VPCGatewayAttachment"
    vpcId = vpc(properties).res.id
    internetGatewayId = internetGateway(properties).res.id
}

function privateSubnets(properties: Dynamic?): Listing = new Listing {
    new subnet.Subnet {
        label = "PrivateSubnet1"
        stack = vars.stack.res
        vpcId = vpc(properties).res.id
        cidrBlock = "10.0.1.0/24"
        availabilityZone = properties.region.value + "a"
        tags {
          new { key = "Name"; value = properties.name.value + "-private-subnet-1" }
        }
    }

    new subnet.Subnet {
        label = "PrivateSubnet2"
        stack = vars.stack.res
        vpcId = vpc(properties).res.id
        cidrBlock = "10.0.2.0/24"
        availabilityZone = properties.region.value + "b"
        tags {
          new { key = "Name"; value = properties.name.value + "-private-subnet-2" }
        }
    }
}
