/*
 * Â© 2025 Platform Engineering Labs Inc.
 *
 * SPDX-License-Identifier: FSL-1.1-ALv2
 */

import "@formae/formae.pkl"
import "@aws/ec2/vpc.pkl"
import "@aws/ec2/securitygroup.pkl"
import "@aws/ec2/securitygroupingress.pkl"
import "./vars.pkl"
import "./nvpc.pkl"

function securityGroups(properties: Dynamic?): Listing = new Listing {
    local albSg = new securitygroup.SecurityGroup {
        label = "lifeline-alb-sg"
        groupDescription = "Allow HTTP traffic to ALB"
        vpcId = nvpc.nvpc(properties).res.id
        tags { new { key = "Name"; value = formae.value(properties.name.value + "-alb-sg").setOnce } }
    }
    albSg

    local albHttpIngress = new securitygroupingress.SecurityGroupIngress {
        label = "lifeline-alb-http-ingress"
        ipProtocol = "tcp"
        fromPort = 80
        toPort = 80
        groupId = albSg.res.groupId
        cidrIp = "0.0.0.0/0"
    }
    albHttpIngress

    local taskSg = new securitygroup.SecurityGroup {
        label = "lifeline-task-sg"
        groupDescription = "Allow HTTP traffic from ALB"
        vpcId = nvpc.nvpc(properties).res.id
        tags { new { key = "Name"; value = formae.value(properties.name.value + "-task-sg").setOnce } }
    }
    taskSg

    local taskHttpIngress = new securitygroupingress.SecurityGroupIngress {
        label = "lifeline-task-http-ingress"
        ipProtocol = "tcp"
        fromPort = 80
        toPort = 80
        sourceSecurityGroupId = albSg.res.groupId
        groupId = taskSg.res.groupId
    }
    taskHttpIngress

    /*
    local albHttpsSg = new securitygroup.SecurityGroup {
        label = "lifeline-alb-https-sg"
        groupDescription = "Allow HTTPS traffic to ALB"
        vpcId = nvpc.nvpc(Properties).res.id
        tags { new { key = "Name"; Value = properties.name.value + "-alb-https-sg" } }
    }

    albHttpsSg

    local albHttpsIngress = new securitygroupingress.SecurityGroupIngress {
        label = "lifeline-alb-https-ingress"
        ipProtocol = "tcp"
        fromPort = 443
        toPort = 443
        cidrIp = "0.0.0.0/0"
        groupId = albHttpsSg.res.groupId
    }
    albHttpsIngress
    */

}