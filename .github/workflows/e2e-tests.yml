name: formae-e2e-tests

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["formae-go"]  # e2e runs only after formae-go workflow completes
    types:
      - completed
    branches: [ "main" ]

# Ensure only one E2E test runs at a time
concurrency:
  group: e2e-tests
  cancel-in-progress: true

permissions:
  id-token: write
  contents: read

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # 1 hour timeout
    # Only run if the triggering workflow succeeded
    if: >-
      ${{ github.event_name == 'workflow_dispatch' ||
         github.event.workflow_run.conclusion == 'success' }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Install pkl
        uses: pkl-community/setup-pkl@v0
        with:
          pkl-version: 0.29.0

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Install aws-nuke
        run: |
          wget -O aws-nuke.tar.gz https://github.com/ekristen/aws-nuke/releases/download/v3.56.2/aws-nuke-v3.56.2-linux-amd64.tar.gz
          tar -xzf aws-nuke.tar.gz
          sudo mv aws-nuke /usr/local/bin/
          sudo chmod +x /usr/local/bin/aws-nuke
          aws-nuke version

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25.1'

      - name: Install pkl
        uses: pkl-community/setup-pkl@v0
        with:
          pkl-version: 0.29.0

      - name: Configure AWS Credentials
        id: creds
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-west-2
          role-to-assume: arn:aws:iam::942849037363:role/admin-test-pel
          role-session-name: PublishSession
          output-credentials: true

      - name: Add profile credentials to ~/.aws/credentials
        run: |
          mkdir -p ~/.aws
          aws configure set aws_access_key_id ${{ steps.creds.outputs.aws-access-key-id }} --profile e2e-test
          aws configure set aws_secret_access_key ${{ steps.creds.outputs.aws-secret-access-key }} --profile e2e-test
          aws configure set region us-west-2 --profile e2e-test
        # aws configure set aws_session_token ${{ steps.creds.outputs.aws-session-token }} --profile e2e-test
      - name: Test AWS Access
        run: aws sts get-caller-identity

      - name: Running e2e-tests
        env:
          AWS_PROFILE: e2e-test
        run: make test-e2e

      - name: Nuke Discovery
        if: ${{ always() }}
        #env:
        #  AWS_PROFILE: e2e-test
        run: |
          aws-nuke nuke -c tests/e2e/config/nuke-config.yaml --no-prompt --prompt-delay 3

      - name: Nuke AWS
        if: ${{ always() }}
        #env:
        #  AWS_PROFILE: e2e-test
        run: |
          aws-nuke nuke -c tests/e2e/config/nuke-config.yaml --no-prompt --no-dry-run
