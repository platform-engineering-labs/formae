/*
 * Â© 2025 Platform Engineering Labs Inc.
 *
 * SPDX-License-Identifier: FSL-1.1-ALv2
 */

/// Generates resolvables.pkl with dynamic imports for all schema packages.
///
/// This module reads dependencies from PklProject and generates a resolvables.pkl
/// file that iterates through all schema packages to find Resolvable classes.
///
/// Usage:
///   pkl eval ResolvablesGenerator.pkl
///
/// Output:
///   A resolvables.pkl module with GetAllResolvableTypes() and
///   MapResolvableResourceUri() functions that work with any combination
///   of providers (AWS, GCP, Azure, etc.)
module formae.generator.ResolvablesGenerator

import "PklProject"

/// Dependencies to exclude from schema imports (core libraries, not resource providers)
local excludedDependencies: List<String> = List("formae")

/// Get dependency names from PklProject, excluding core libraries
local schemaPackageNames: List<String> =
    PklProject.dependencies.keys.toList().filter((name) -> !excludedDependencies.contains(name))

output {
    text = new Listing {
        "// Generated by ResolvablesGenerator.pkl"
        "// Do not edit manually"
        ""
        "module generator"
        ""
        "import \"pkl:reflect\""
        "import \"./imports.pkl\""
        ""
        "open class Resolvable {"
        "    type: String"
        "    clazz: Class"
        "    typeLower = type.toLowerCase()"
        "    moduleName: String"
        "    importName: String = moduleName.replaceAll(\".pkl\", \"\").split(\"/\").last"
        "}"
        ""
        "function GetAllResolvableTypes(): Listing<Resolvable> = new Listing {"
        "    for (_packageName, packageModules in imports.packages) {"
        "        for (modName, modValue in packageModules) {"
        "            when (reflect.Module(modValue).classes.length > 0) {"
        "                for (_className, v in reflect.Module(modValue).classes) {"
        "                    for (prop in v.properties) {"
        "                        when (prop.name == \"type\" && v.supertype.referent.name == \"Resolvable\") {"
        "                            new Resolvable {"
        "                                moduleName = modName"
        "                                type = prop.defaultValue.toString()"
        "                                clazz = v.reflectee"
        "                            }"
        "                        }"
        "                    }"
        "                }"
        "            }"
        "        }"
        "    }"
        "}"
        ""
        "function MapResolvableResourceUri(): Map<String, Resolvable> ="
        "    let (res = GetAllResolvableTypes().fold(Map(), (acc: Map<String, Resolvable>, item) ->"
        "        let (typeUri = item.type)"
        "            if (acc.containsKey(typeUri)) throw (\"Duplicate Resolvable Type URI: \" + typeUri) else acc.put(typeUri, item)"
        "    ))"
        "    res"
        ""
        "output {"
        "    text = MapResolvableResourceUri().getOrNull(\"AWS::ApiGateway::ApiKey\")?.clazz.simpleName"
        "}"
    }.join("\n")
}
