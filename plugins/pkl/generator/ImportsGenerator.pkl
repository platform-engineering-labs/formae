/*
 * Â© 2025 Platform Engineering Labs Inc.
 *
 * SPDX-License-Identifier: FSL-1.1-ALv2
 */

/// Generates imports.pkl with wildcard imports for schema packages.
///
/// This module reads dependencies from PklProject and generates import*() calls
/// for each schema package dependency (excludes the "formae" core library).
///
/// Usage:
///   pkl eval ImportsGenerator.pkl
///
/// Output:
///   packages: Mapping<String, Mapping<String, Module>> = new Mapping {
///     ["@aws"] = import*("@aws/**/*.pkl")
///     ["@gcp"] = import*("@gcp/**/*.pkl")
///   }
module formae.generator.ImportsGenerator

import "PklProject"

/// Dependencies to exclude from schema imports (core libraries, not resource providers)
local excludedDependencies: List<String> = List("formae")

/// Get dependency names from PklProject, excluding core libraries
local schemaPackageNames: List<String> =
    PklProject.dependencies.keys.toList().filter((name) -> !excludedDependencies.contains(name))

output {
    text = new Listing {
        "// Generated by ImportsGenerator.pkl"
        "// Do not edit manually"
        ""
        "packages: Mapping<String, Mapping<String, Module>> = new Mapping {"
        for (name in schemaPackageNames) {
            // Use both patterns: *.pkl for root level files, **/*.pkl for subdirectories
            // This works around a pkl quirk where ** doesn't match zero directories
            "    [\"@\(name)\"] = new Mapping { ...import*(\"@\(name)/*.pkl\"); ...import*(\"@\(name)/**/*.pkl\") }"
        }
        "}"
    }.join("\n")
}
