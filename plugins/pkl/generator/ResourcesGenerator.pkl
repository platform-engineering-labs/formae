/*
 * Â© 2025 Platform Engineering Labs Inc.
 *
 * SPDX-License-Identifier: FSL-1.1-ALv2
 */

/// Generates resources.pkl with dynamic imports for all schema packages.
///
/// This module reads dependencies from PklProject and generates a resources.pkl
/// file that iterates through all schema packages to find Resource classes
/// annotated with @ResourceHint.
///
/// Usage:
///   pkl eval ResourcesGenerator.pkl
///
/// Output:
///   A resources.pkl module with GetAllResourceTypes() function that works
///   with any combination of providers (AWS, GCP, Azure, etc.)
module formae.generator.ResourcesGenerator

import "PklProject"

/// Dependencies to exclude from schema imports (core libraries, not resource providers)
local excludedDependencies: List<String> = List("formae")

/// Get dependency names from PklProject, excluding core libraries
local schemaPackageNames: List<String> =
    PklProject.dependencies.keys.toList().filter((name) -> !excludedDependencies.contains(name))

output {
    text = new Listing {
        "// Generated by ResourcesGenerator.pkl"
        "// Do not edit manually"
        ""
        "module generator"
        ""
        "import \"pkl:reflect\""
        "import \"@formae/formae.pkl\""
        "import \"./imports.pkl\""
        ""
        "open class Resource {"
        "    type: String"
        "    moduleName: String"
        "    clazz: Class"
        "    className: String = clazz.simpleName"
        "    importName: String = moduleName.replaceAll(\".pkl\", \"\").split(\"/\").last"
        "}"
        ""
        "function GetAllResourceTypes(): Listing<Resource> = new Listing {"
        "    for (_packageName, packageModules in imports.packages) {"
        "        for (modName, moduleValue in packageModules) {"
        "            when (reflect.Module(moduleValue).classes.length > 0) {"
        "                for (_className, v in reflect.Module(moduleValue).classes) {"
        "                    when (v.annotations.length > 0 && v.annotations[0].getClass().simpleName == \"ResourceHint\") {"
        "                        new Resource {"
        "                            type = v.annotations[0].getProperty(\"type\")"
        "                            moduleName = modName"
        "                            clazz = v.reflectee"
        "                        }"
        "                    }"
        "                }"
        "            }"
        "        }"
        "    }"
        "}"
        ""
        "output {"
        "    text = GetAllResourceTypes().toList().join(\"\\n\")"
        "}"
    }.join("\n")
}
