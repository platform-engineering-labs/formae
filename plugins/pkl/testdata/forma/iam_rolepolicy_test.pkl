/*
 * Â© 2025 Platform Engineering Labs Inc.
 *
 * SPDX-License-Identifier: FSL-1.1-ALv2
 */

amends "@formae/forma.pkl"
import "@formae/formae.pkl"
import "@aws/iam/rolepolicy.pkl"
import "@aws/aws.pkl"

// This test creates inline policies for each of 3 IAM roles
// Used to test discovery of inline policies
properties {
  policyNamePrefix = new formae.Prop {
    flag = "policy-name-prefix"
    default = "TestInlinePolicy"
  }
}

local roleNames = new Listing {
    "simple-lambda-lambda-role-simple-lambda-lambda-role"
    "pkl-evaluator-lambda-role-pkl-evaluator-lambda-role"
    "pkl-evaluator-execution-role"
}

forma {
  new formae.Stack {
    label = "iam-rolepolicy-stack"
    description = "Stack for IAM RolePolicy bulk test"
  }

  new formae.Target {
    label = "default-aws-target"
    config = new aws.Config {
      region = "us-west-2"
    }
  }

  for (r in roleNames) {
    for (i in IntSeq(1, 20)) {
      new rolepolicy.RolePolicy {
        label = "policy-\(roleName)-\(i)"
        policyName = "\(properties.policyNamePrefix.value)-\(i)"
        roleName = r
        policyDocument {
          ["Version"] = "2012-10-17"
          ["Statement"] = new Listing {
            new {
              ["Effect"] = "Allow"
              ["Action"] = new Listing {
                "logs:CreateLogGroup"
                "logs:CreateLogStream"
                "logs:PutLogEvents"
              }
              ["Resource"] = "*"
            }
          }
        }
      }
    }
  }
}