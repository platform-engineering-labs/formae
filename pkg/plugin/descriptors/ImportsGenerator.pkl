/*
 * Â© 2025 Platform Engineering Labs Inc.
 *
 * SPDX-License-Identifier: FSL-1.1-ALv2
 */

/// Generates a PKL file with wildcard imports for schema packages.
///
/// Reads dependencies from PklProject and generates import*() calls for each
/// schema package dependency (excludes the "formae" core library).
///
/// Usage:
///   pkl eval ImportsGenerator.pkl
///
/// Output:
///   packages {
///     ["@aws"] = import*("@aws/**/*.pkl")
///     ["@gcp"] = import*("@gcp/**/*.pkl")
///   }
module forma.plugin.ImportsGenerator

import "PklProject"

/// Dependencies that should be excluded from schema imports (core libraries, not resource providers)
local excludedDependencies: List<String> = List("formae")

/// Get all dependency names from PklProject, excluding core libraries
local schemaPackageNames: List<String> =
    PklProject.dependencies.keys.toList().filter((name) -> !excludedDependencies.contains(name))

/// Generate the output with wildcard imports for each schema package
/// Includes both root-level files (*.pkl) and subdirectory files (**/*.pkl)
/// so simple plugins don't need to create subdirectories.
output {
    text = new Listing {
        "// Generated by ImportsGenerator.pkl"
        "// Do not edit manually"
        ""
        "packages: Mapping<String, Mapping<String, Module>> = new Mapping {"
        for (name in schemaPackageNames) {
            "    [\"@\(name)\"] = import*(\"@\(name)/*.pkl\")"
            "    [\"@\(name)/sub\"] = import*(\"@\(name)/**/*.pkl\")"
        }
        "}"
    }.join("\n")
}
